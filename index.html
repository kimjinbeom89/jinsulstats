<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>진료 통계 분석기</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input[type="file"], input[type="text"] { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>진료 통계 분석기 (2025.5.19)</h1>
  <input type="file" id="fileInput" accept=".xlsx,.csv" />
  <br />
  <label>접수메모 키워드 (완전일치, 대소문자 무시):</label>
  <input type="text" id="keywordInput" placeholder="예: pt만" />
  <button onclick="processFile()">분석 실행</button>
  <div id="output"></div>

  <script>
    function processFile() {
      const fileInput = document.getElementById('fileInput');
      const keyword = document.getElementById('keywordInput').value.toLowerCase();
      if (!fileInput.files.length) return alert("파일을 업로드해주세요.");

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        let allData = [];
        workbook.SheetNames.forEach(name => {
          const sheet = workbook.Sheets[name];
          const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
          allData = allData.concat(json);
        });

        analyzeData(allData, keyword);
      };
      reader.readAsArrayBuffer(fileInput.files[0]);
    }

    function analyzeData(data, keyword) {
      const mapCol = {
        chart: ['차트번호', '환자번호', '번호'],
        room: ['진료실', '진료구분'],
        type: ['초/재', '구분'],
        date: ['진료일자', '날짜'],
        injection: ['마취', '주사'],
        memo: ['접수메모', '메모']
      };

      const columns = {};
      const firstRow = data[0];
      for (const key in mapCol) {
        const match = Object.keys(firstRow).find(col => mapCol[key].some(k => col.includes(k)));
        if (!match) return alert(`❌ 열 누락: ${key}`);
        columns[key] = match;
      }

      const groupBy = (arr, keyFn) => arr.reduce((acc, row) => {
        const key = keyFn(row);
        (acc[key] = acc[key] || []).push(row);
        return acc;
      }, {});

      const uniqueCount = (arr, key) => new Set(arr.map(x => x[key])).size;

      const rooms = [...new Set(data.map(row => row[columns.room] || ''))].sort();
      const allRooms = ['전체', ...rooms];

      const results = [];

      allRooms.forEach(roomName => {
        const df = roomName === '전체' ? data : data.filter(row => row[columns.room] === roomName);
        const total = uniqueCount(df, columns.chart);
        const first = df.filter(r => /초진|신환|90일/i.test(r[columns.type]));
        const firstIds = [...new Set(first.map(r => r[columns.chart]))];
        const re = df.filter(r => /재진|물리치료|산정안함/i.test(r[columns.type]));
        const inj = df.filter(r => r[columns.injection].includes('●'));
        const injFirst = inj.filter(r => firstIds.includes(r[columns.chart]));
        const injFirstIds = [...new Set(injFirst.map(r => r[columns.chart]))];

        const visits = groupBy(df.filter(r => injFirstIds.includes(r[columns.chart])), r => r[columns.chart]);
        const visitCounts = Object.values(visits).map(arr => new Set(arr.map(r => r[columns.date])).size);

        const count = arr => visitCounts.filter(n => n === arr).length;
        const countOver = n => visitCounts.filter(v => v >= n).length;

        const keywordCount = df.filter(r => (r[columns.memo] || '').toLowerCase() === keyword).length;

        results.push({
          진료실: roomName,
          초진: firstIds.length,
          재진: uniqueCount(re, columns.chart),
          총합: total,
          '초진 주사 처방률': percent(injFirstIds.length, firstIds.length),
          '주사환자 재진율': percent(visitCounts.filter(n => n >= 2).length, injFirstIds.length),
          '평균주사횟수': avg(groupBy(inj, r => r[columns.chart])),
          '주사환자 평균내원횟수': avg(groupBy(df.filter(r => injFirstIds.includes(r[columns.chart])), r => r[columns.chart])),
          '초진평균내원횟수': avg(groupBy(df.filter(r => injFirstIds.includes(r[columns.chart])), r => r[columns.chart])),
          '신환 재내원율': percent(visitCounts.filter(n => n > 1).length, visitCounts.length),
          '1회 내원 비율': percent(count(1), visitCounts.length),
          '2회 내원 비율': percent(count(2), visitCounts.length),
          '3회 내원 비율': percent(count(3), visitCounts.length),
          '4회 내원 비율': percent(count(4), visitCounts.length),
          '5회 이상 내원 비율': percent(countOver(5), visitCounts.length),
          '키워드일치 건수': keywordCount
        });
      });

      renderTable(results);
    }

    function percent(n, d) {
      return d ? Math.round((n / d) * 100) + "%" : "0%";
    }

    function avg(grouped) {
      const sizes = Object.values(grouped).map(arr => arr.length);
      if (!sizes.length) return 0;
      return (sizes.reduce((a, b) => a + b, 0) / sizes.length).toFixed(1);
    }

    function renderTable(data) {
      const output = document.getElementById("output");
      const keys = Object.keys(data[0]);
      let html = `<table><thead><tr>${keys.map(k => `<th>${k}</th>`).join("")}</tr></thead><tbody>`;
      data.forEach(row => {
        html += `<tr>${keys.map(k => `<td>${row[k]}</td>`).join("")}</tr>`;
      });
      html += "</tbody></table>";
      output.innerHTML = html;
    }
  </script>
</body>
</html>
