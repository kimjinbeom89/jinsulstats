<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì™¸ë˜ í†µê³„ ìë™ ê³„ì‚° ë„êµ¬</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h1 { color: #2c3e50; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    select, label { margin: 10px; }
    .warn { color: red; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ì™¸ë˜ í†µê³„ ìë™ ê³„ì‚°ê¸°</h1>
  <input type="file" id="excelFile" accept=".xlsx" />
  <div id="mappingSection"></div>
  <div id="output"></div>
  <div id="warning" class="warn"></div>

  <script>
    let rawHeaders = [];
    let rawDataRows = [];

    function generateMappingUI(headers) {
      const fields = {
        "ì´ˆì¬": "ì´ˆ/ì¬ êµ¬ë¶„",
        "ì± íŠ¸ë²ˆí˜¸": "ì± íŠ¸ë²ˆí˜¸",
        "ë§ˆì·¨": "ë§ˆì·¨ ì—¬ë¶€",
        "ì§„ë£Œê³¼": "ì§„ë£Œê³¼"
      };

      let html = '<h3>ğŸ“Œ ì—´ ë§¤í•‘ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>';
      for (let key in fields) {
        html += `<label>${fields[key]}: <select id="map_${key}">` +
                headers.map(h => `<option value="${h}">${h}</option>`).join('') +
                '</select></label><br/>';
      }
      html += '<button onclick="processMapping()">í†µê³„ ê³„ì‚° ì‹œì‘</button>';
      document.getElementById('mappingSection').innerHTML = html;
    }

    function processMapping() {
      const headerMap = {
        'ì´ˆì¬': document.getElementById('map_ì´ˆì¬').value,
        'ì± íŠ¸ë²ˆí˜¸': document.getElementById('map_ì± íŠ¸ë²ˆí˜¸').value,
        'ë§ˆì·¨': document.getElementById('map_ë§ˆì·¨').value,
        'ì§„ë£Œê³¼': document.getElementById('map_ì§„ë£Œê³¼').value
      };

      const df = rawDataRows.map(row => {
        let obj = {};
        rawHeaders.forEach((col, i) => {
          obj[col] = row[i];
        });
        return obj;
      });

      const ì¬ì§„ì¡°ê±´ = ["ì¬ì§„", "ë¬¼ë¦¬ì¹˜ë£Œë‚´ì›", "ì§„ì°°ë£Œ ì‚°ì •ì•ˆí•¨"];
      const ì§„ë£Œì‹¤ëª©ë¡ = [...new Set(df.map(r => r[headerMap['ì§„ë£Œê³¼']] || 'ê¸°íƒ€'))];

      function countStats(data, ì§„ë£Œì‹¤) {
        const sub = ì§„ë£Œì‹¤ === "ì „ì²´" ? data : data.filter(r => (r[headerMap['ì§„ë£Œê³¼']] || 'ê¸°íƒ€') === ì§„ë£Œì‹¤);
        const ì´ˆì§„í™˜ì = sub.filter(r => ["ì‹ í™˜", "90ì¼ì´ˆì§„"].includes(r[headerMap['ì´ˆì¬']]));
        const ì´ˆì§„ì°¨íŠ¸ = [...new Set(ì´ˆì§„í™˜ì.map(r => r[headerMap['ì± íŠ¸ë²ˆí˜¸']]))];

        const ì¬ì§„ë°©ë¬¸ìˆ˜ = sub.filter(r => ì¬ì§„ì¡°ê±´.includes(r[headerMap['ì´ˆì¬']])).length;
        const ì´ë°©ë¬¸ìˆ˜ = sub.length;

        const ì´ˆì§„ì£¼ì‚¬ = ì´ˆì§„í™˜ì.filter(r => (r[headerMap['ë§ˆì·¨']] || '').includes('â—'));
        const ì´ˆì§„ì£¼ì‚¬ì²˜ë°©ë¥  = ì´ˆì§„ì°¨íŠ¸.length ? Math.round((ì´ˆì§„ì£¼ì‚¬.length / ì´ˆì§„ì°¨íŠ¸.length) * 100) : 0;

        const ì£¼ì‚¬ì°¨íŠ¸ = [...new Set(ì´ˆì§„ì£¼ì‚¬.map(r => r[headerMap['ì± íŠ¸ë²ˆí˜¸']]))];
        const ì£¼ì‚¬ê¸°ë¡ = sub.filter(r => ì£¼ì‚¬ì°¨íŠ¸.includes(r[headerMap['ì± íŠ¸ë²ˆí˜¸']]));

        const ì£¼ì‚¬íšŸìˆ˜ = {}, ë‚´ì›íšŸìˆ˜_ì£¼ì‚¬ = {};
        ì£¼ì‚¬ê¸°ë¡.forEach(r => {
          const key = r[headerMap['ì± íŠ¸ë²ˆí˜¸']];
          if ((r[headerMap['ë§ˆì·¨']] || '').includes('â—')) {
            ì£¼ì‚¬íšŸìˆ˜[key] = (ì£¼ì‚¬íšŸìˆ˜[key] || 0) + 1;
          }
          ë‚´ì›íšŸìˆ˜_ì£¼ì‚¬[key] = (ë‚´ì›íšŸìˆ˜_ì£¼ì‚¬[key] || 0) + 1;
        });

        const í‰ê· ì£¼ì‚¬íšŸìˆ˜ = Object.keys(ì£¼ì‚¬íšŸìˆ˜).length ? (Object.values(ì£¼ì‚¬íšŸìˆ˜).reduce((a, b) => a + b, 0) / Object.keys(ì£¼ì‚¬íšŸìˆ˜).length).toFixed(1) : 0;
        const í‰ê· ë‚´ì›ì£¼ì‚¬ = Object.keys(ë‚´ì›íšŸìˆ˜_ì£¼ì‚¬).length ? (Object.values(ë‚´ì›íšŸìˆ˜_ì£¼ì‚¬).reduce((a, b) => a + b, 0) / Object.keys(ë‚´ì›íšŸìˆ˜_ì£¼ì‚¬).length).toFixed(1) : 0;

        const ì „ì²´ì´ˆì§„ê¸°ë¡ = sub.filter(r => ì´ˆì§„ì°¨íŠ¸.includes(r[headerMap['ì± íŠ¸ë²ˆí˜¸']]));
        const ì´ˆì§„ë‚´ì› = {};
        ì „ì²´ì´ˆì§„ê¸°ë¡.forEach(r => {
          const key = r[headerMap['ì± íŠ¸ë²ˆí˜¸']];
          ì´ˆì§„ë‚´ì›[key] = (ì´ˆì§„ë‚´ì›[key] || 0) + 1;
        });

        const ì´ˆì§„í‰ê· ë‚´ì› = Object.keys(ì´ˆì§„ë‚´ì›).length ? (Object.values(ì´ˆì§„ë‚´ì›).reduce((a, b) => a + b, 0) / Object.keys(ì´ˆì§„ë‚´ì›).length).toFixed(1) : 0;
        const ì¬ë‚´ì›ìˆ˜ = Object.values(ì´ˆì§„ë‚´ì›).filter(n => n >= 2).length;
        const ì´ˆì§„ì¬ë‚´ì›ìœ¨ = Object.keys(ì´ˆì§„ë‚´ì›).length ? Math.round((ì¬ë‚´ì›ìˆ˜ / Object.keys(ì´ˆì§„ë‚´ì›).length) * 100) : 0;

        const ë‚´ì›ë¹„ìœ¨ = count => Math.round((Object.values(ì´ˆì§„ë‚´ì›).filter(n => n === count).length / Object.keys(ì´ˆì§„ë‚´ì›).length) * 100);
        const ë‚´ì›ë¹„ìœ¨_5ì´ìƒ = Math.round((Object.values(ì´ˆì§„ë‚´ì›).filter(n => n >= 5).length / Object.keys(ì´ˆì§„ë‚´ì›).length) * 100);

        return {
          "êµ¬ë¶„": ì§„ë£Œì‹¤,
          "ì´ˆì§„í™˜ììˆ˜": ì´ˆì§„ì°¨íŠ¸.length,
          "ì¬ì§„í™˜ììˆ˜": ì¬ì§„ë°©ë¬¸ìˆ˜,
          "ì´í™˜ììˆ˜": ì´ë°©ë¬¸ìˆ˜,
          "ì´ˆì§„ ì£¼ì‚¬ ì²˜ë°©ë¥ ": `${ì´ˆì§„ì£¼ì‚¬ì²˜ë°©ë¥ }%`,
          "ì´ˆì§„ ì£¼ì‚¬í™˜ì ì¬ì§„ìœ¨": `${Math.round((Object.values(ë‚´ì›íšŸìˆ˜_ì£¼ì‚¬).filter(v => v >= 2).length / Object.keys(ë‚´ì›íšŸìˆ˜_ì£¼ì‚¬).length) * 100) || 0}%`,
          "ì´ˆì§„ì£¼ì‚¬í™˜ì í‰ê·  ì£¼ì‚¬íšŸìˆ˜": í‰ê· ì£¼ì‚¬íšŸìˆ˜,
          "ì´ˆì§„ ì£¼ì‚¬í™˜ì í‰ê· ë‚´ì›íšŸìˆ˜": í‰ê· ë‚´ì›ì£¼ì‚¬,
          "ì´ˆì§„í‰ê· ë‚´ì›íšŸìˆ˜": ì´ˆì§„í‰ê· ë‚´ì›,
          "ì´ˆì§„ ì¬ë‚´ì›ìœ¨": `${ì´ˆì§„ì¬ë‚´ì›ìœ¨}%`,
          "1íšŒ ë‚´ì› ë¹„ìœ¨": `${ë‚´ì›ë¹„ìœ¨(1)}%`,
          "2íšŒ ë‚´ì› ë¹„ìœ¨": `${ë‚´ì›ë¹„ìœ¨(2)}%`,
          "3íšŒ ë‚´ì› ë¹„ìœ¨": `${ë‚´ì›ë¹„ìœ¨(3)}%`,
          "4íšŒ ë‚´ì› ë¹„ìœ¨": `${ë‚´ì›ë¹„ìœ¨(4)}%`,
          "5íšŒ ì´ìƒ ë‚´ì› ë¹„ìœ¨": `${ë‚´ì›ë¹„ìœ¨_5ì´ìƒ}%`
        };
      }

      const í†µê³„ = [countStats(df, "ì „ì²´")].concat(ì§„ë£Œì‹¤ëª©ë¡.map(j => countStats(df, j)));
      const keys = Object.keys(í†µê³„[0]);
      let html = '<table><thead><tr>' + keys.map(k => `<th>${k}</th>`).join('') + '</tr></thead><tbody>';
      í†µê³„.forEach(row => {
        html += '<tr>' + keys.map(k => `<td>${row[k]}</td>`).join('') + '</tr>';
      });
      html += '</tbody></table>';
      document.getElementById('output').innerHTML = html;
    }

    document.getElementById('excelFile').addEventListener('change', function(e) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        let sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: "" });

        let headerRowIndex = sheetData.findIndex(row => row.filter(cell => typeof cell === 'string' && cell.toString().trim().length > 0).length >= 4);
        rawHeaders = sheetData[headerRowIndex];
        rawDataRows = sheetData.slice(headerRowIndex + 1);

        generateMappingUI(rawHeaders);
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    });
  </script>
</body>
</html>
